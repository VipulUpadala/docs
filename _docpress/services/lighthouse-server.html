
<div class="doc-layout">
  <div class="toggle menu-toggle js-menu-toggle"></div>
  <ul class="menu toc-menu">
    <li class="menu-item -level-0 -parent">
      <ul class="submenu">
        <li class="menu-item -level-1"><a class="link title  link-index" href="index.html">Tide</a>
        </li>
        <li class="menu-item -level-1 -parent"><a class="link title  link-installation" href="installation/index.html">Installation</a>
          <ul class="submenu">
            <li class="menu-item -level-2"><a class="link title  link-installationprerequisites" href="installation/prerequisites.html">Prerequisites</a>
            </li>
            <li class="menu-item -level-2"><a class="link title  link-installationcloning" href="installation/cloning.html">Cloning</a>
            </li>
            <li class="menu-item -level-2"><a class="link title  link-installationsetup" href="installation/setup.html">Setup</a>
            </li>
          </ul>
        </li>
        <li class="menu-item -level-1 -parent"><a class="link title  link-services" href="services/index.html">Services</a>
          <ul class="submenu">
            <li class="menu-item -level-2"><a class="link title  link-servicesapi" href="services/api.html">API</a>
            </li>
            <li class="menu-item -level-2"><a class="link title  link-servicessync-server" href="services/sync-server.html">Sync Server</a>
            </li>
            <li class="menu-item -level-2"><a class="link title  link-servicesphpcs-server" href="services/phpcs-server.html">PHPCS Server</a>
            </li>
            <li class="menu-item -level-2"><a class="link title -active link-serviceslighthouse-server" href="services/lighthouse-server.html">Lighthouse Server</a>
              <ul class="headings heading-list">
                <li class="heading-item -depth-2"><a class="hlink link-environment-variables" href="#environment-variables">Environment Variables</a>
                </li>
                <li class="heading-item -depth-2"><a class="hlink link-commands" href="#commands">Commands</a>
                </li>
                <li class="heading-item -depth-2"><a class="hlink link-running-audits" href="#running-audits">Running audits</a>
                  <ul class="heading-list -depth-2">
                    <li class="heading-item -depth-3"><a class="hlink link-components" href="#components">Components</a>
                    </li>
                    <li class="heading-item -depth-3"><a class="hlink link-process" href="#process">Process</a>
                    </li>
                    <li class="heading-item -depth-3"><a class="hlink link-reports" href="#reports">Reports</a>
                    </li>
                  </ul>
                </li>
              </ul>
            </li>
          </ul>
        </li>
        <li class="menu-item -level-1 -parent"><a class="link title  link-gcp" href="gcp/index.html">Google Cloud Platform</a>
          <ul class="submenu">
            <li class="menu-item -level-2"><a class="link title  link-gcpgoogle-cloud-storage" href="gcp/google-cloud-storage.html">Google Cloud Storage</a>
            </li>
            <li class="menu-item -level-2"><a class="link title  link-gcpgoogle-cloud-firestore" href="gcp/google-cloud-firestore.html">Google Cloud Firestore</a>
            </li>
            <li class="menu-item -level-2"><a class="link title  link-gcpgoogle-cloud-sql" href="gcp/google-cloud-sql.html">Google Cloud SQL</a>
            </li>
            <li class="menu-item -level-2"><a class="link title  link-gcpgoogle-cloud-memorystore" href="gcp/google-cloud-memorystore.html">Google Cloud Memorystore</a>
            </li>
            <li class="menu-item -level-2"><a class="link title  link-gcpgoogle-app-engine" href="gcp/google-app-engine.html">Google App Engine</a>
            </li>
            <li class="menu-item -level-2"><a class="link title  link-gcpgoogle-kubernetes-engine" href="gcp/google-kubernetes-engine.html">Google Kubernetes Engine</a>
            </li>
          </ul>
        </li>
        <li class="menu-item -level-1"><a class="link title  link-aws" href="aws/index.html">Amazon Web Services</a>
        </li>
        <li class="menu-item -level-1 -parent"><span class="title">Important Links</span>
          <ul class="submenu">
            <li class="menu-item -level-2"><a class="link title  link-help" href="help.html">Help</a>
            </li>
            <li class="menu-item -level-2"><a class="link title  link-local-development" href="local-development.html">Local Development</a>
            </li>
            <li class="menu-item -level-2"><a class="link title  link-contributing" href="contributing.html">Contributing</a>
            </li>
            <li class="menu-item -level-2"><a class="link title  link-code-of-conduct" href="code-of-conduct.html">Code of Conduct</a>
            </li>
            <li class="menu-item -level-2"><a class="link title  link-roadmap" href="roadmap.html">Roadmap</a>
            </li>
            <li class="menu-item -level-2"><a class="link title  link-sponsors" href="sponsors.html">Sponsors</a>
            </li>
            <li class="menu-item -level-2"><a class="link title  link-license" href="license.html">License</a>
            </li>
            <li class="menu-item -level-2"><a class="link title  link-search" href="search.html">API Search</a>
            </li>
          </ul>
        </li>
        <li class="menu-item -level-1"><a class="link title  link-404" href="404.html">404</a>
        </li>
      </ul>
    </li>
  </ul>
  <div class="body page-serviceslighthouse-server">
    <div class="header-nav">
      <div class="right"><a class="iconlink" href="https://github.com/wptide/docs" data-title="wptide/docs" title="GitHub"><span class="icon -github"></span></a><a class="iconlink" href="https://make.wordpress.org/tide/" data-title="make.wordpress.org/tide" title="WordPress"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 1000"><path d="M10 500a490 490 0 1 0 980 0 490 490 0 0 0-980 0zm38 0c0-66 14-128 39-184l216 591A452 452 0 0 1 48 500zm452 452c-44 0-87-6-128-18l136-394 139 380 3 7c-47 16-97 25-150 25zm366-460a427 427 0 0 0 31-209 450 450 0 0 1-170 608l139-399zm-98-140c17 30 37 69 37 125 0 39-11 87-34 146l-45 151-164-486c28-1 52-4 52-4 24-3 22-39-3-38 0 0-73 6-120 6-45 0-119-6-119-6-25-1-28 36-3 38l47 4 71 193-99 297-165-490c27-1 52-4 52-4 24-3 21-39-3-38 0 0-73 6-121 6h-29a452 452 0 0 1 683-85l-5-1c-45 0-76 39-76 80 0 38 21 69 44 106z"/></svg></a></div>
    </div>
    <div class="markdown-body"><h1 id="lighthouse-server">Lighthouse Server</h1>
<p>The Lighthouse Server is a Go binary installed on an Alpine Linux Docker image that reads messages from a queue and runs Google Lighthouse reports against themes, then sends the results back to the Tide API.</p>
<p>It is important to note that the server only works for <a href="http://wp.org">wp.org</a> themes and the most recent version of it. This means that in a headless instance of Chromium the Lighthouse CLI audits each theme by loading the demo version found on <a href="http://wp-themes.com">wp-themes.com</a>, which is always the latest version so if you request a theme audit for a previous version the results will be for the latest one. Eventually, we will look into a way to load the theme into the container and audit any version on request.</p>
<h2 id="environment-variables">Environment Variables</h2>
<table>
<thead>
<tr>
<th style="text-align:left">Variable</th>
<th style="text-align:left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>LH_CONCURRENT_AUDITS</code></td>
<td style="text-align:left">Sets the number of goroutines the server will perform concurrently. Default is <code>5</code>. <em>This is currently deactivated and will have no impact during runtime.</em></td>
</tr>
<tr>
<td style="text-align:left"><code>LH_MESSAGE_PROVIDER</code></td>
<td style="text-align:left">Queue audit messages using the local MongoDB, Google Cloud Firestore, or AWS SQS. Must be one of: <code>local</code>, <code>firestore</code>, <code>sqs</code>. Default is <code>local</code>.</td>
</tr>
<tr>
<td style="text-align:left"><code>LH_STORAGE_PROVIDER</code></td>
<td style="text-align:left">Upload reports to the local file system, Google Cloud Storage, or AWS S3. Must be one of: <code>local</code>, <code>gcs</code>, <code>s3</code>. Default is <code>local</code>.</td>
</tr>
<tr>
<td style="text-align:left"><code>LH_TEMP_FOLDER</code></td>
<td style="text-align:left">Sets the temporary folder inside the container used to store downloaded files. Default is <code>/tmp</code>.</td>
</tr>
</tbody>
</table>
<h2 id="commands">Commands</h2>
<table>
<thead>
<tr>
<th style="text-align:left">Command</th>
<th style="text-align:left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>make lighthouse.build.bin</code></td>
<td style="text-align:left">Build the Lighthouse Server Go binary.</td>
</tr>
<tr>
<td style="text-align:left"><code>make lighthouse.clean.bin</code></td>
<td style="text-align:left">Clean the Lighthouse Server Go binary.</td>
</tr>
<tr>
<td style="text-align:left"><code>make lighthouse.build.image</code></td>
<td style="text-align:left">Build the Lighthouse Server Docker image.</td>
</tr>
<tr>
<td style="text-align:left"><code>make lighthouse.build.up</code></td>
<td style="text-align:left">Rebuild the Lighthouse Server Docker image and run the container in isolation with docker-compose up.</td>
</tr>
<tr>
<td style="text-align:left"><code>make lighthouse.up</code></td>
<td style="text-align:left">Run the Lighthouse Server Docker image in isolation with docker-compose up.</td>
</tr>
<tr>
<td style="text-align:left"><code>make lighthouse.down</code></td>
<td style="text-align:left">Take the isolated Lighthouse Server Docker container down.</td>
</tr>
<tr>
<td style="text-align:left"><code>make lighthouse.stop</code></td>
<td style="text-align:left">Stop the isolated Lighthouse Server Docker container with docker-compose stop.</td>
</tr>
<tr>
<td style="text-align:left"><code>make lighthouse.rm</code></td>
<td style="text-align:left">Remove the stopped Lighthouse Server Docker container with docker-compose rm.</td>
</tr>
<tr>
<td style="text-align:left"><code>make lighthouse.push.image</code></td>
<td style="text-align:left">Push the Lighthouse Server Docker image to GCR.</td>
</tr>
<tr>
<td style="text-align:left"><code>make lighthouse.clean.image</code></td>
<td style="text-align:left">Clean the Lighthouse Server Docker image from the host machine.</td>
</tr>
<tr>
<td style="text-align:left"><code>make lighthouse.build.cluster</code></td>
<td style="text-align:left">Build the Lighthouse Server GKE cluster.</td>
</tr>
<tr>
<td style="text-align:left"><code>make lighthouse.creds</code></td>
<td style="text-align:left">Get the Lighthouse Server GKE cluster credentials.</td>
</tr>
<tr>
<td style="text-align:left"><code>make lighthouse.tpl</code></td>
<td style="text-align:left">Generate the Lighthouse Server GKE YAML template.</td>
</tr>
<tr>
<td style="text-align:left"><code>make lighthouse.deploy.cluster</code></td>
<td style="text-align:left">Deploy the Lighthouse Server GKE cluster.</td>
</tr>
<tr>
<td style="text-align:left"><code>make lighthouse.get.cluster</code></td>
<td style="text-align:left">Get the Lighthouse Server GKE cluster status.</td>
</tr>
<tr>
<td style="text-align:left"><code>make lighthouse.clean.cluster</code></td>
<td style="text-align:left">Clean the Lighthouse Server GKE cluster.</td>
</tr>
</tbody>
</table>
<h2 id="running-audits">Running audits</h2>
<p>This section described the components included in the Lighthouse integration with Tide, demonstrates the Lighthouse audit process, and provides example Tide API audit results.</p>
<h3 id="components">Components</h3>
<p>The following outlines the components needed to integrate Lighthouse auditing of WordPress themes into the Tide API.</p>
<ol>
<li>Docker Container <code>lighthouse-server</code>
<ul>
<li>Chromium</li>
<li>Lighthouse CLI</li>
<li>Lighthouse Server Go binary</li>
</ul>
</li>
<li>Lighthouse Server Source Code
<ul>
<li><code>bin/lighthouse-server</code> built Lighthouse Server Go binary.</li>
<li><code>cmd/lighthouse-server</code> Lighthouse Server Go source code.</li>
<li><code>service/lighthouse-server</code> <code>make</code> , Docker, and Kubernetes configurations.</li>
<li><code>vendor</code> imported Go dependencies.</li>
</ul>
</li>
</ol>
<h3 id="process">Process</h3>
<p>The following demonstrates how a WordPress theme is run through a Lighthouse audit and has its results stored and returned via the Tide API.</p>
<ol>
<li>The Tide API starts and listens for requests.</li>
</ol>
<p><img src="images/api-php-start.png" alt></p>
<ol>
<li>The Lighthouse Server starts and attempts to authenticate with the Tide API.</li>
</ol>
<p><img src="images/lighthouse-server-auth.png" alt></p>
<ol>
<li>The Tide API receives an authentication request from the Lighthouse Server.</li>
</ol>
<p><img src="images/api-php-auth.png" alt></p>
<ol>
<li>The Lighthouse Server is authenticated and starts polling the message queue.</li>
</ol>
<p><img src="images/lighthouse-server-poll.png" alt></p>
<ol>
<li>The theme is downloaded and a checksum is calculated.</li>
</ol>
<p><img src="images/lighthouse-server-checksum.png" alt></p>
<ol>
<li>The source code is ran through <code>gocloc</code> to get code information.</li>
</ol>
<p><img src="images/lighthouse-server-code-info.png" alt></p>
<ol>
<li>The source is scanned for the Theme header information.</li>
</ol>
<p><img src="images/lighthouse-server-header.png" alt></p>
<ol>
<li>Runs the theme preview URL (<code>https://wp-themes.com/&lt;theme-slug&gt;</code>) through a <code>lighthouse</code> audit and keeps polling for the next job.</li>
</ol>
<p><img src="images/lighthouse-server-audit.png" alt></p>
<ol>
<li>Uploads the raw report to a storage provider (GCS, S3, or local) and generates a summary report.</li>
</ol>
<p><img src="images/lighthouse-server-audit-complete.png" alt></p>
<ol>
<li>The Lighthouse Server bundles the summary report and reference to the raw report as a message payload and sends the payload to the Tide API.</li>
</ol>
<p><img src="images/lighthouse-server-payload.png" alt></p>
<ol>
<li>The Tide API updates the audit endpoint after receiving the <code>POST</code> request from the Lighthouse Server.</li>
</ol>
<p><img src="images/api-php-payload.png" alt></p>
<ol>
<li>Finally the message is removed from the queue.</li>
</ol>
<p><img src="images/lighthouse-server-queue.png" alt></p>
<h3 id="reports">Reports</h3>
<p>The following is a Tide API audit object showing a Lighthouse summary report.</p>
<h4 id="http:tide.localapitidev1auditwporgthemetwentyseventeen2.1"><code>http://tide.local/api/tide/v1/audit/wporg/theme/twentyseventeen/2.1</code></h4>
<p><img src="images/lighthouse-server-summary-report.png" alt="Lighthouse Summary Report"></p>
<p>The following is a Tide API report object showing a download link to the original Lighthouse report. This demonstrates the local disk storage, a cloud provider will look a bit different and the URL will expire.</p>
<h4 id="http:tide.localapitidev1report236rawlighthouse"><code>http://tide.local/api/tide/v1/report/236/raw/lighthouse</code></h4>
<p><img src="images/lighthouse-server-raw-report.png" alt="Lighthouse Summary Report"></p>

    </div>
    <div class="footer-nav">
      <div class="left"><a href="../services/phpcs-server.html"><span class="title">PHPCS Server</span></a></div>
      <div class="right"><a href="../gcp/index.html"><span class="label">Next: </span><span class="title">Google Cloud Platform</span></a></div>
    </div>
  </div>
</div>